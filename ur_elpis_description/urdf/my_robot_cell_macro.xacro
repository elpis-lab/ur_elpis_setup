<?xml version="1.0"?>
<robot xmlns:xacro="http://ros.org/wiki/xacro">
  <xacro:include filename="$(find ur_description)/urdf/ur_macro.xacro"/>
  <xacro:include filename="$(find realsense2_description)/urdf/_d435.urdf.xacro"/>

  <xacro:macro name="my_robot_cell" params="
    parent
    *origin
    ur_type
    joint_limits_parameters_file
    kinematics_parameters_file
    physical_parameters_file
    visual_parameters_file
    ">

    <!-- ============================================ -->
    <!-- Mounting Plate -->
    <!-- ============================================ -->
    <link name="mounting_plate">
      <visual>
        <geometry>
          <box size="0.2 0.2 0.005"/>  <!-- 20cm x 20cm x 5mm -->
        </geometry>
        <origin xyz="0 0 0.0025" rpy="0 0 0"/>
        <material name="plate_material">
          <color rgba="0.5 0.5 0.5 1.0"/>
        </material>
      </visual>
      <collision>
        <geometry>
          <box size="0.2 0.2 0.005"/>
        </geometry>
        <origin xyz="0 0 0.0025" rpy="0 0 0"/>
      </collision>
      <inertial>
        <mass value="0.2"/>
        <origin xyz="0 0 0.0025" rpy="0 0 0"/>
        <inertia ixx="0.001" ixy="0.0" ixz="0.0" iyy="0.001" iyz="0.0" izz="0.001"/>
      </inertial>
    </link>
    <joint name="world_to_plate" type="fixed">
      <xacro:insert_block name="origin" />
      <parent link="${parent}" />
      <child link="mounting_plate"/>
      <origin xyz="0.0 0.0 0.0" rpy="0 0 0"/>
    </joint>

    <!-- ============================================ -->
    <!-- UR Robot -->
    <!-- ============================================ -->
    <xacro:ur_robot
      name="${ur_type}"
      tf_prefix="${ur_type}_"
      parent="mounting_plate"
      joint_limits_parameters_file="${joint_limits_parameters_file}"
      kinematics_parameters_file="${kinematics_parameters_file}"
      physical_parameters_file="${physical_parameters_file}"
      visual_parameters_file="${visual_parameters_file}"
      generate_ros2_control_tag="false">
     
      <origin xyz="0 0 0" rpy="0 0 -3.141592653589793" />   <!-- Rotate 180 degrees to match original config in our lab setup-->
    </xacro:ur_robot>

    <!-- ============================================ -->
    <!-- Gripper (Robotis RH-P12-RN) -->
    <!-- ============================================ -->
    <material name="grey">
      <color rgba="0.2 0.2 0.2 1.0"/>
    </material>
    
    <joint name="tool0_rh_p12_rn_base" type="fixed">    <!-- Joint connecting UR tool frame to gripper -->
      <origin rpy="0 0 1.570794" xyz="0 0 0"/>
      <parent link="${ur_type}_tool0"/>
      <child link="rh_p12_rn_base"/>
    </joint>

    <link name="rh_p12_rn_base">
      <collision>
        <origin xyz="0 0 0" rpy="0 0 0"/>
        <geometry>
          <mesh filename="package://ur_elpis_description/assets/robotis_rh_p12_rn/collision/base.stl" scale="0.001 0.001 0.001"/>
        </geometry>
      </collision>
      <visual>
        <origin xyz="0 0 0" rpy="0 0 0"/>
        <geometry>
          <mesh filename="package://ur_elpis_description/assets/robotis_rh_p12_rn/visual/base.stl" scale="0.001 0.001 0.001"/>
        </geometry>
        <material name="grey"/>
      </visual>
      <inertial>
        <origin xyz="0.000 0.000 0.032" rpy="0 0 0"/>
        <mass value="0.236"/>
        <inertia ixx="0.001" ixy="0.0" ixz="0.0" iyy="0.001" iyz="0.0" izz="0.001" />
      </inertial>
    </link>
    <joint name="rh_p12_rn" type="revolute">
      <parent link="rh_p12_rn_base"/>
      <child link="rh_p12_rn_r1"/>
      <origin xyz="0.0 0.008 0.058" rpy="0 0 0"/>
      <axis xyz="1 0 0"/>
      <limit lower="0.0" upper="1.12" effort="100.0" velocity="1.0"/>
    </joint>
    <link name="rh_p12_rn_r1">
      <collision>
        <origin xyz="0 0 0" rpy="0 0 0"/>
        <geometry>
          <mesh filename="package://ur_elpis_description/assets/robotis_rh_p12_rn/collision/r1.stl" scale="0.001 0.001 0.001"/>
        </geometry>
      </collision>
      <visual>
        <origin xyz="0 0 0" rpy="0 0 0"/>
        <geometry>
          <mesh filename="package://ur_elpis_description/assets/robotis_rh_p12_rn/visual/r1.stl" scale="0.001 0.001 0.001"/>
        </geometry>
        <material name="grey"/>
      </visual>
      <inertial>
        <origin xyz="0.000 0.034 0.004" rpy="0 0 0"/>
        <mass value="0.068"/>
        <inertia ixx="0.001" ixy="0.0" ixz="0.0" iyy="0.001" iyz="0.0" izz="0.001" />
      </inertial>
    </link>
    <joint name="rh_r2" type="revolute">
      <parent link="rh_p12_rn_r1"/>
      <child link="rh_p12_rn_r2"/>
      <origin xyz="0.0 0.0493634 0.0285" rpy="0 0 0"/>
      <axis xyz="-1 0 0"/>
      <limit lower="0.0" upper="1.12" effort="100.0" velocity="1.0"/>
      <mimic joint="rh_p12_rn" multiplier="1.0" offset="0.0"/>
    </joint>
    <link name="rh_p12_rn_r2">
      <collision>
        <origin xyz="0 0 0" rpy="0 0 0"/>
        <geometry>
          <mesh filename="package://ur_elpis_description/assets/robotis_rh_p12_rn/collision/r2.stl" scale="0.001 0.001 0.001"/>
        </geometry>
      </collision>
      <visual>
        <origin xyz="0 0 0" rpy="0 0 0"/>
        <geometry>
          <mesh filename="package://ur_elpis_description/assets/robotis_rh_p12_rn/visual/r2.stl" scale="0.001 0.001 0.001"/>
        </geometry>
        <material name="grey"/>
      </visual>
      <inertial>
        <origin xyz="0.000 0.006 0.011" rpy="0 0 0"/>
        <mass value="0.022"/>
        <inertia ixx="0.001" ixy="0.0" ixz="0.0" iyy="0.001" iyz="0.0" izz="0.001" />
      </inertial>
    </link>
    <joint name="rh_l1" type="revolute">
      <parent link="rh_p12_rn_base"/>
      <child link="rh_p12_rn_l1"/>
      <origin xyz="0.0 -0.008 0.058" rpy="0 0 0"/>
      <axis xyz="-1 0 0"/>
      <limit lower="0.0" upper="1.12" effort="100.0" velocity="1.0"/>
      <mimic joint="rh_p12_rn" multiplier="1.0" offset="0.0"/>
    </joint>
    <link name="rh_p12_rn_l1">
      <collision>
        <origin xyz="0 0 0" rpy="0 0 0"/>
        <geometry>
          <mesh filename="package://ur_elpis_description/assets/robotis_rh_p12_rn/collision/l1.stl" scale="0.001 0.001 0.001"/>
        </geometry>
      </collision>
      <visual>
        <origin xyz="0 0 0" rpy="0 0 0"/>
        <geometry>
          <mesh filename="package://ur_elpis_description/assets/robotis_rh_p12_rn/visual/l1.stl" scale="0.001 0.001 0.001"/>
        </geometry>
        <material name="grey"/>
      </visual>
      <inertial>
        <origin xyz="0.000 -0.034 0.004" rpy="0 0 0"/>
        <mass value="0.068"/>
        <inertia ixx="0.001" ixy="0.0" ixz="0.0" iyy="0.001" iyz="0.0" izz="0.001" />
      </inertial>
    </link>
    <joint name="rh_l2" type="revolute">
      <parent link="rh_p12_rn_l1"/>
      <child link="rh_p12_rn_l2"/>
      <origin xyz="0.0 -0.0493634 0.0285" rpy="0 0 0"/>
      <axis xyz="1 0 0"/>
      <limit lower="0.0" upper="1.12" effort="100.0" velocity="1.0"/>
      <mimic joint="rh_p12_rn" multiplier="1.0" offset="0.0"/>
    </joint>
    <link name="rh_p12_rn_l2">
      <collision>
        <origin xyz="0 0 0" rpy="0 0 0"/>
        <geometry>
          <mesh filename="package://ur_elpis_description/assets/robotis_rh_p12_rn/collision/l2.stl" scale="0.001 0.001 0.001"/>
        </geometry>
      </collision>
      <visual>
        <origin xyz="0 0 0" rpy="0 0 0"/>
        <geometry>
          <mesh filename="package://ur_elpis_description/assets/robotis_rh_p12_rn/visual/l2.stl" scale="0.001 0.001 0.001"/>
        </geometry>
        <material name="grey"/>
      </visual>
      <inertial>
        <origin xyz="0.000 -0.006 0.011" rpy="0 0 0"/>
        <mass value="0.022"/>
        <inertia ixx="0.001" ixy="0.0" ixz="0.0" iyy="0.001" iyz="0.0" izz="0.001" />
      </inertial>
    </link>
    <joint name="ee_fixed_joint" type="fixed">
      <parent link="rh_p12_rn_base"/>
      <child link="ee_link"/>
      <origin rpy="0.0 0.0 0.0" xyz="0.0 0.0 0.145"/>
    </joint>
    <link name="ee_link">
      <inertial>
        <mass value="1e-3"/>
        <origin rpy="0 0 0" xyz="0.0 0.0 0.0"/>
        <inertia ixx="1e-5" ixy="0.0" ixz="0.0" iyy="1e-5" iyz="0.0" izz="1e-5"/>
      </inertial>
    </link>

    <!-- ============================================ -->
    <!-- Camera (RealSense D435) -->
    <!-- ============================================ -->
    <!-- Using realsense2_description macro for D435 camera -->
    <xacro:sensor_d435 parent="rh_p12_rn_base" name="camera" use_nominal_extrinsics="true" use_mesh="true">
      <!-- TODO: Calculate exact transform from tool0 to camera_color_optical_frame and replace current values-->
      <!-- - Measured calibration: tool0 -> camera_color_optical_frame -->
      <!-- - Inverse of: camera_bottom_screw_frame -> camera_color_optical_frame (from macro) -->
      <!-- - Accounted for tool0 -> rh_p12_rn_base rotation (90Â° around Z) -->
      <origin rpy="-1.292395 -1.516365 1.320174" xyz="-0.050732 -0.007579 0.060014"/>
       <!-- Assuming camera mounted on camera_bottom_screw_frame, so getting accurate pose of camera_bottom_screw_frame is crucial-->
    </xacro:sensor_d435>

  </xacro:macro>
</robot>
